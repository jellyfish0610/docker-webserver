log_format timed_combined '$remote_addr - $remote_user [$time_local] $request_time "$request" $status $bytes_sent "$http_referer" "$http_user_agent"';

upstream fpm_backend {
  server <PHPFPM_HOST>:<PHPFPM_PORT>;
}

large_client_header_buffers 16 32k;

# Main handler, without API

server {

  listen 80;
  listen [::]:80;

  client_max_body_size 10m;

  server_name <DOMAIN_PLACEHOLDER>;
  server_name boodmo.<DOMAIN_PLACEHOLDER>;
  server_name static.<DOMAIN_PLACEHOLDER>;

  root   /var/www/current/public;
  autoindex off;


  # Block access to "hidden" files and directories whose names begin with a
  # period. This includes directories used by version control systems such
  # as Subversion or Git to store control files.
  location ~ (^|/)\. {
    return 403;
  }

  if ($request_uri ~ /sitemap[^/]*\.xml) {
    rewrite /sitemap([^/]*)\.xml /sitemaps/sitemap$1.xml;
  }


  if ($request_uri ~ ((?i)\/pages|\/catalog|\/vehicles(?-i))(.*)) {
      rewrite ^([^.]*[^/])$ $1/ permanent;
  }


  location @rewriteindex {
    rewrite ^(.*)$ /index.php/$1 last;
  }

  location / {
    <HTTP_AUTH>
    # try to serve file directly, fallback to app.php
    try_files $uri @rewriteindex;

  }

  ## Forward paths like /js/index.php/x.js to relevant handler
  location ~ .php/ {
    rewrite ^(.*.php)/ $1 last;
  }

  location = /nginx_status {
    stub_status on;
    access_log off;
    allow 127.0.0.1;
    allow 172.30.0.166;
    deny all;
  }


 location ~ \.php {
    fastcgi_pass fpm_backend;
    fastcgi_split_path_info ^(.+\.php)(/.*)$;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_param HTTPS $http_X_Forwarded_Https;
    fastcgi_param REMOTE_ADDR $http_X_FORWARDED_FOR;
    fastcgi_param APPLICATION_SCOPE site;
    fastcgi_buffers 256 32k;
    fastcgi_buffer_size 256k;
    fastcgi_busy_buffers_size 256k;
    fastcgi_temp_file_write_size 256k;
    fastcgi_param APPLICATION_ENV <APPLICATION_ENV>;
    fastcgi_read_timeout 2400;
  }


  location ~ (/img/) {
    auth_basic off;
    expires 24h;
    try_files $uri  @rewriteindex;
  }

  location ~ (/htimg/display|\.css|\.js|\.jpg|\.png|\.gif|\.ico) {
    auth_basic off;
    expires max;
    try_files $uri  @rewriteindex;
  }

}

# Media server
server {

  listen 80;
  listen [::]:80;

  server_name media.<DOMAIN_PLACEHOLDER>;
  access_log /var/log/nginx/access.media.log timed_combined;
  root   /var/www/shared/media;
  autoindex off;

  location / {
    allow all;
  }

}


# API handler
server {

  listen 80;
  listen [::]:80;

  client_max_body_size 10m;

  server_name api.<DOMAIN_PLACEHOLDER>;

  root   /var/www/current/public;
  autoindex off;


  # Block access to "hidden" files and directories whose names begin with a
  # period. This includes directories used by version control systems such
  # as Subversion or Git to store control files.
  location ~ (^|/)\. {
    return 403;
  }

  # Do NOT honour HTTP authentication when requesting special URL patterns
  location ~ "^/v1/api/" {
    auth_basic  off;
    # try to serve file directly, fallback to app.php
    try_files $uri  @rewriteindex;
  }

  location @rewriteindex {
    rewrite ^(.*)$ /index.php/$1 last;
  }

  location / {
    # try to serve file directly, fallback to app.php
    try_files $uri  @rewriteindex;

  }

  ## Forward paths like /js/index.php/x.js to relevant handler
  location ~ .php/ {
    rewrite ^(.*.php)/ $1 last;
  }



location ~ \.php {
    fastcgi_pass fpm_backend;
    fastcgi_split_path_info ^(.+\.php)(/.*)$;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_param HTTPS $http_X_Forwarded_Https;
    fastcgi_param REMOTE_ADDR $http_X_FORWARDED_FOR;
    fastcgi_param APPLICATION_SCOPE api;
    fastcgi_buffers 256 32k;
    fastcgi_buffer_size 256k;
    fastcgi_busy_buffers_size 256k;
    fastcgi_temp_file_write_size 256k;
    fastcgi_param APPLICATION_ENV <APPLICATION_ENV>;
    fastcgi_read_timeout 2400;
  }
}
